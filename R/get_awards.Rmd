---
title: "R Notebook"
output: html_notebook
editor_options: 
  chunk_output_type: inline
---

```{r setup}

pacman::p_load(curl, 
               magrittr, 
               dplyr, 
               purrr, 
               rvest, 
               glue, 
               httr, 
               jsonlite, 
               readr, 
               httr)

```


```{r yourvariables}

# what are you searching for
query <- '"artificial intelligence"'

#when you run manually on https://www.fwc.gov.au/document-search how many results are there? (will automate this later)
n_results <- 19

```

```{r fixedvariables}

source(here::here("R/get_page_data.R"))
source(here::here("R/sanitize_flename.R"))
source(here::here("R/download_pdf_viewer.R"))

# DONT EDIT THESE LINES
start_page <- 1
query <- URLencode(query)
base_query <- glue::glue('https://www.fwc.gov.au/document-search?options=SearchType_3%2CSortOrder_agreement-relevance&q={query}&pagesize=50&page=')

pages <- ceiling(n_results/50)

sanitized_filename <- sanitize_filename(stringr::str_trim(URLdecode(query)))

file_pattern <- paste0("^\\d{4}-\\d{2}-\\d{2}-", gsub(" ", "-", sanitized_filename), "\\.rds$") # File pattern for matching

```

```{r getdata}

# Check for existing files matching the pattern
matching_files <- list.files(here::here("data"), pattern = file_pattern, full.names = TRUE)


if (length(matching_files) > 0) {
  # If multiple matching files are found, use the most recently dated
  latest_file <- matching_files[which.max(file.info(matching_files)$mtime)]
  
  # Ask if the user wants to re-query
  message("Matching file found: ", latest_file)
  user_response <- readline(prompt = "Do you want to re-query the data? (yes/no): ")
  
  if (tolower(user_response) == "no") {
    # Load the existing file
    message("Loading the existing file...")
    data <- readRDS(latest_file)
  }} else {
    # Run the block and save the output with today's date
    message("querying the data...")
    all_data <- map(1:pages, ~get_page_data(base_query, .x))
    documents <- all_data[[1]]$documentResult$results %>%
      dplyr::as_tibble()
    
    documents <- documents %>%
      mutate(decodedURL = )
    
    output_file <- file.path(data_dir, paste0(Sys.Date(), "-", gsub(" ", "-", sanitized_filename), ".rds"))
    saveRDS(documents, output_file)
    message("Data saved to: ", output_file)
}




```

```{r getpdfs}

# Use walk2 to iterate over metadata_storage_path and PublicationID
walk2(documents$document.metadata_storage_path, 
      documents$document.PublicationID, 
      download_pdf_viewer)

```

